<!DOCTYPE html>
<html lang="en">
    <style>
        body {
            background: #000;
        }
        html, body{ 
            min-height: 97vh;
            overflow: auto;
        }
    </style>
	<body>
    <script src="r73/three.js"></script>
    <script src="r73/OrbitControls.js"></script>
    <script src="files.js"></script>
    <script src="utils.js"></script>
    <script id="vs" type="x-shader/x-vertex">
        varying vec2 vUv; 
        uniform float alpha;

        void main() {
            gl_Position = vec4( position, 1.0 );
        }
    </script>

    <script id="fs" type="x-shader/x-fragment">
        uniform sampler2D iChannel0;
        uniform sampler2D iChannel1;
        uniform sampler2D iChannel2;
        uniform sampler2D iChannel3;
        varying vec2 vUv;  
        uniform float alpha;
        uniform vec2 resolution;
        void main() {
            vec2 uv = vec2(gl_FragCoord.x / resolution.x, gl_FragCoord.y / resolution.y);
            vec4 pr;

            // see: https://en.wikipedia.org/wiki/Alpha_compositing#Description

            vec4 p0 = texture2D( iChannel0,  uv);
            pr = p0;

            vec4 p1 = texture2D( iChannel1,  uv);
            pr = p1*alpha + pr * (1.0 - alpha);

            vec4 p2 = texture2D( iChannel2,  uv);
            pr = p2*alpha + pr * (1.0 - alpha);

            vec4 p3 = texture2D( iChannel3,  uv);
            pr = p3*alpha + pr * (1.0 - alpha);

            gl_FragColor =  pr;
            pr.a = 1.0;            
        }

    </script>
    <script>

        var _container;
        var _camera, _scene, _renderer;
        var  _shaderMaterial;
        var _scene;
        var _planes;
        var xValue = window.innerWidth, yValue=window.innerHeight;
        var _mat = new THREE.ShaderMaterial( {
                uniforms: {
                    iChannel0:  { type: 't', value: 0 },
                    iChannel1:  { type: 't', value: 0 },
                    iChannel2:  { type: 't', value: 0 },
                    iChannel3:  { type: 't', value: 0 },
                    alpha: {type: 'f', value: 0.6 },
                    resolution: { type: "v2", value: new THREE.Vector2() }
                },
                vertexShader: document.getElementById( 'vs' ).textContent,
                fragmentShader: document.getElementById( 'fs' ).textContent,
                transparent: true, opacity: 0.0
            } );
        function init() {
            _scene = new THREE.Scene();

            _container = document.getElementsByTagName( 'body' )[0];
            console.log("body", _container.clientWidth, _container.clientHeight);
            _renderer =  new THREE.WebGLRenderer({antialias: true, alpha: true});
            _container.innerHTML = "";
            _container.appendChild( _renderer.domElement );
            _camera = new THREE.PerspectiveCamera( 60, xValue/yValue, 1, 20000 );
            shuffleBoneList();
            textureLoader(callback);
        }
        function callback() {
            count = 0;
            _mat.uniforms.iChannel0 =  { type: 't', value: _textures[count++] };
            _mat.uniforms.iChannel1 =  { type: 't', value: _textures[count++] };
            _mat.uniforms.iChannel2 =  { type: 't', value: _textures[count++] };
            _mat.uniforms.iChannel3 =  { type: 't', value: _textures[count++] };

            console.log(_container.clientWidth, _container.clientHeight);
            _renderer.setSize( xValue, yValue);
            
            var plane = new THREE.Mesh(new THREE.PlaneGeometry(xValue, yValue), _mat);
            _scene.add(plane);       
            _renderer.render( _scene, _camera );
            requestAnimationFrame( render );
        }
        function render() {
            requestAnimationFrame( render );
            _renderer.render( _scene, _camera );
        }

        function resize() {
            console.log("Resizing.......");
            xValue = _container.clientWidth;
            yValue= _container.clientHeight;

            console.log("window", xValue, yValue);

            _mat.uniforms.resolution.value.x = xValue;
            _mat.uniforms.resolution.value.y = yValue;

            _renderer.setSize( xValue, yValue);
            console.log("pixelRatio", window.devicePixelRatio);
            console.log("container", _container.clientWidth, _container.clientHeight);
            // _camera.aspect = xValue/yValue;

            // var w = window.innerWidth*.98;
            // var h = window.innerHeight*.98;
            // var ar = w/h;
            // var magicNumber = 1.01;
            // if (ar <magicNumber) {
            //     h = w/magicNumber
            // }
            // else {
            //     w = h*magicNumber
            // }

            // _renderer.setSize( w, h );
        }


        init();
        window.addEventListener('resize', function () {resize();}, false);
        resize();
    </script>
	</body>
</html>
